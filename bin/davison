#! /usr/bin/env bash
command=$1
shift

[ ! -n "$command" ] && {
    echo "Chris Davison's utilities"
    echo "usage: $(basename "$0") command args..."
    echo ""
    echo "Available commands"
    echo ""
    echo "    printbefore           print a csv with datecolumn 0 before a certain date"
    echo "    printafter            print a csv with datecolumn 0 after a certain date"
    echo "    printbetween          print a csv with datecolumn 0 between dates"
    echo "    extract               generic archive extractor"
    echo "    catless               either cat or less, depending on terminal size"
    echo "    mans"
    echo "    running               list running jobs"
    echo "    uuidrecord            generate and record a uuid"
    echo "    uuidlast              return the last recorded uuid"
    echo "    myip"
    echo "    headtail|ht"
    echo "    eps2pdf"
    echo "    svg2eps"
    echo "    docker"
    exit
}

case "$command" in
    print|p)
        cmd="$1"; shift;
        case "$cmd" in
            before)
                awk -v date="$1" '$0 ~ "^"date{exit} {print $0}' "$2" ;;
            after)
                awk -v date="$1" '$0 ~ "^"date{start=1} start==1{print $0}' "$2" ;;
            between)
                awk -v date1="$1" -v date2="$2" '$0 ~ "^"date1{start=1} $0 ~ "^"date2{exit} start==1{print $0}' "$3" ;;
        esac ;;
    extract)
        if [ -f "$1" ] ; then
            case "$1" in
                *.tar.bz2)   tar xjf "$1"     ;;
                *.tar.gz)    tar xzf "$1"     ;;
                *.bz2)       bunzip2 "$1"     ;;
                *.rar)       unrar e "$1"     ;;
                *.gz)        gunzip "$1"      ;;
                *.tar)       tar xf "$1"      ;;
                *.tbz2)      tar xjf "$1"     ;;
                *.tgz)       tar xzf "$1"     ;;
                *.zip)       unzip "$1"       ;;
                *.Z)         uncompress "$1"  ;;
                *.7z)        7z x "$1"        ;;
                *)     echo "'$1' cannot be extracted via $(basename "$0") extract" ;;
            esac
        else
            echo "'$1' is not a valid file"
        fi ;;
    catless)
        height=$(tput lines)
        fileheight=$(wc -l "$1" | awk '{print $1}')
        if [[ $height -gt $fileheight ]]; then
            cat "$1"
        else
            less "$1"
        fi ;;
    mans) man "$1" | grep -iC2 --color=always "$2" | less ;;
    running) ps | tr -s " " | cut -d' ' -f 3- | awk 'NR>1{print}' ;;
    uuidrecord) echo "$(uuid)" > ~/.lastuuid && cat ~/.lastuuid ;;
    uuidlast) [ -f ~/.lastuuid ] && cat ~/.lastuuid ;;
    docker)
       opt="$1"; shift;
       case "$opt" in
           kotlin)
              inp="$1"; shift;
              out=$(davison filenameNoExt "$inp").jar
              docker run -it --rm -v "$(pwd)":/home/ zenika/alpine-kotlin kotlinc /home/"$inp" -include-runtime -d /home/"$out" ;;
            pandoc) docker run -it --rm -v "$(pwd)":/source jagregory/pandoc ;;
            ipy|py|python)
               docker run -it --rm -v "$(pwd)":/home/jovyan/work/ jupyter/tensorflow-notebook start.sh ipython ;;
            iex)
                docker run -it --rm -v "$(pwd)":/home/ elixir:latest iex "$1" ;;
            elixir)
                docker run -it --rm -v "$(pwd)":/home/ elixir:latest sh ;;
            help|h|usage)
                echo "davison docker <command>"
                echo ""
                echo "    kotlin: compile and jar, with runtime, your kotlin file"
                echo "    pandoc: run the passed command, with current dir mounted"
                echo "    elixir: run iex with whatever input is given"
                echo "    python: launch an ipython shell with tensorflow/ml environment"
                ;;
       esac ;;
    esac
exit $?
