#!/usr/bin/env sh
opt="$1"; shift
logbook_today=$(date +"%Y/%Y-%m-%d--%a.md")
lb=$LOGBOOK_DIR$logbook_today
case "$opt" in 
    edit|e) $EDITOR "$lb" ;;
    view|v) [ -e "$lb" ] && davison catless "$lb" || echo "No logbook entry today" ;;
    previous|p)
        dir="$LOGBOOK_DIR$(date +'%Y/')"
        if [ -e "$lb" ]; then
            prev=$(find "$dir" | sort | tail -n2 | head -n 1)
        else
            prev=$(find "$dir" | sort | tail -n1)
        fi
        davison catless "$prev"
        ;;
    diff|d)
        pushd "$LOGBOOK_DIR" || exit
        git ls-files --error-unmatch "$logbook_today" > /dev/null 2>&1
        if [[ $? -gt 0 ]]; then
            cat "$logbook_today"
            echo ""
            echo "====================================="
            echo "        NOT ADDED TO REPO YET        "
            echo "====================================="
        else
            git diff "$logbook_today"
        fi
        popd || exit ;;
    commit|c)
        msg="$1"
        pushd "$LOGBOOK_DIR" || exit
        git add "$logbook_today"
        if [ "$msg" = "" ]; then
            git commit -m "Log $(date +%F)"
        elif [ "$msg" = "i" ]; then
            git commit
        else
            git commit -m "Log $msg"
        fi 
        popd || exit ;;
    history|h)
        step="$1"
        if [ ! -n "$step" ]; then
            step=7
        fi
        target=$(date -v"-$step""d" +"%F--%a.md")
        lb_yr_dir=$LOGBOOK_DIR$(date +"%Y/")
        echo "" > ~/.logbook_history
        for f in $lb_yr_dir*; do
            base="$(basename "$f")"
            if [ "$base" \> "$target" ]; then
                cat "$f" >> ~/.logbook_history
            fi
        done
        pandoc ~/.logbook_history -f gfm --mathjax --standalone -o ~/.logbook_history.epub
        echo "Created ~/.logbook_history.epub with last $step days logbooks"
        [ -f "$HOME/.logbook_history" ] && rm ~/.logbook_history
        ;;
    *)
        base=$(basename "$0")
        echo "usage: '$base' logbook edit|view|commit" ;;
esac
